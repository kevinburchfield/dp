import { Component } from '@angular/core';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css']
})
export class AppComponent {
  permutations: string[] = [];
  superpermutation = '';
  lastExecutionTiming: number;
  preknownSPs = {
    2: '121',
    3: '123121321',
    4: '123412314231243121342132413214321',
    5: '123451234152341253412354123145231425314235142315423124531243512431524312543121345213425134215342135421324513241532413524132541321453214352143251432154321',
    7: '1234567123456172345167234517623451726345172364517234651723456127345162734512673452167345261734526713452673145267341526734512763452176345271634527613452763145276341527634512736452173645271364527316452736145273641527364512734652173465271346527314652734165273461527346512734561237451623745126374521637452613745263174526371452637415263745123674521367452316745321674531267453162745316724531674253167452361745326174536217453612745361724536174253617452367145326714536271453672145367124536714253671452367415326741536274153672415367421536741253674152367451237645213764523176453217645312764531726453176245317642531764523716453271645372164537126453716245371642537164523761453276145372614537621453761245376142537614523764153276415372641537624153764215376412537641523764512374652137465231746532174653127465317246531742653174625317465237146532714653721465371246537142653714625371465237416532741653724165374216537412653741625374165237461532746153724615374261537462153746125374615237465123745612347516234751263475216347526134752631475263417526347152634751236475213647523164753216475312647531624753164275316472531647523614753261475362147536124753614275361472536147523641753264175362417536421753641275364172536417523647153264715362471536427153647215364712536471523647512346752134675231467532146753124675314267531462753146725314675234167532416753421675432167542316754213675421637542167354216753412675431267541326754123675412637541267354126753416275431627541362754163275416237541627354162753416725431672541367254163725416732541672354167253416752346175324617534261754326175423617542631754261375426173542617534621754362175463217546231754621375462173546217534612754361275463127546132754612375461273546127534617254361725463172546137254617325461723546172534617523467153246715342671543267154236715426371542673154267135426715346271543627154632715462371546273154627135462715346721543672154637215467321546723154672135467215346712543671254637125467312546713254671235467125346715234675123476521347652314765321476531247653142765314726531476253147652341765324176534217654321765423176542137654217365421763542176534127654312765413276541237654127365412763541276534172654317265413726541732654172365417263541726534176254317625413762541736254176325417623541762534176523471653247165342716543271654237165427316542713654271635427165347216543721654732165743216573421657324165732146573216457321654723165742316572431657234165723146572316457231654721365742136572413657214365721346572136457213654721635742163572416357214635721643572163457216354721653471265437126547312657431265734126573142657312465731264573126547132657413265714326571342657132465713264571326547123657412365714236571243657123465712364571236547126357412635714263571246357126435712634571263547126534716254371625473162574316257341625731462573164257316245731625471362574136257143625713462571364257136245713625471632574163257146325716432571634257163245716325471623574162357146235716423571624357162345716235471625347165234761532476153427615432761542376154273615427631542761354276153472615437261547326157432615734261573246157326415732614573261547236157423615724361572346157236415723614572361547263157426315724631572643157263415726314572631547261357426135724613572641357261435726134572613547261534762154376215473621574362157346215736421573624157362145736215476321574632157643215674321564732156437215643271564321756432157634215673421563742156347215634271563421756342157632415673241563724156327415632471563241756324157632145673214563721456327145632174563214756321457632154762315746231576423156742315647231564273156423715642317564231576243156724315627431562473156243715624317562431576234156723415627341562374156234715623417562341576231456723145627314562371456231745623147562314576231547621357462135764213567421356472135642713564217356421375642135762413567241356274135624713562417356241375624135762143567214356271435621743562147356214375621435762134567213456271345621734562137456213475621345762135476215347612543761254736125743612573461257364125736142573612457361254763125746312576431256743125647312564371256431725643127564312576341256734125637412563471256341725634127563412576314256731425637142563174256314725631427563142576312456731245637124563172456312745631247563124576312547613257461325764132567413256471325641732564137256413275641325761432567143256174325167432517643251746325174362517432651743256147325164732514673251476325147362514732651473256143725164372514637251436725143762514372651437256143275164327514632751436275143267514327651432756143257613425671342561734251673425176342517364251734625173426517342561374251637425136742513764251374625137426513742561347251634725136472513467251347625134726513472561342751634275136427513462751342675134276513427561342576132456713245617324516732451763245173624517326451732465173245613724516372451367245137624513726451372465137245613274516327451362745132674513276451327465132745613247516324751362475132647513246751324765132475613245761325476123574612357641235674123564712356417235641273564123756412357614235671423561742351674235176423517462351742635174236517423561472351647235146723514762351472635147236514723561427351642735146273514267351427635142736514273561423751642375146237514263751423675142376514237561423576124356712435617243516724351762435172643517246351724365172435612743516274351267435216743526174352671435267413526743152674351276435217643527164352761435276413527643152764351274635217463527146352741635274613527463152746351274365217436527143652741365274316527436152743651274356124735162473512647352164735261473526417352647135264731526473512467352146735241673524617352467135246731524673512476352147635241763524716352476135247631524763512473652147365241736524713652473165247361524736512473561243751624375126437521643752614375264137526431752643715264375124637521463752416375246137524631752463715246375124367521436752413675243167524361752436715243675124376521437652413765243176524371652437615243765124375612435761234576123547612534761523476512347561234,'
  };
  numElements: number;

  generatePermutations(n: number, elements: number[]): void {
    if (n === 1) {
      this.permutations.push(elements.join(''));
    } else {
      for (let i = 0; i < n - 1; i++) {
        this.generatePermutations(n - 1, elements);
        if (n % 2 === 0) {
          [elements[i], elements[n - 1]] = [elements[n - 1], elements[i]];
        } else {
          [elements[0], elements[n - 1]] = [elements[n - 1], elements[0]];
        }
      }
      this.generatePermutations(n - 1, elements);
    }
  }

  generate(n: number): void {
    const start = window.performance.now();
    this.permutations = [];
    this.generatePermutations(n, this.createInitialArray(n));
    const end = window.performance.now();
    this.lastExecutionTiming = end - start;
  }

  createInitialArray(numElements: number): number[] {
    return new Array(numElements)
      .fill(0)
      .map((val, index) => index + 1);
  }

  findSuperpermutation(n: number): void {
    this.superpermutation = '';
    this.numElements = n;
    this.generate(n);
    this.permutations.sort();
    const permutationsClone = [...this.permutations];

    // Get the first permutation because that is going to the first target
    const firstPermutation = permutationsClone[0];
    const permutationLength = firstPermutation.length;

    // Loop over the permutations until there are no more permutations left unplaced
    let overlapResult: [string, number] = [firstPermutation, 0];
    while (permutationsClone.length > 0) {
      // We're on the last permutation
      if (permutationsClone.length === 1) {
        // Handle the unique situation
        this.superpermutation = this.superpermutation
          .concat(permutationsClone[0].substring(permutationLength - 1, permutationLength));
        permutationsClone.pop();
      } else {
        // Remove the permutations from the permutations list
        const indexOfPermutation = permutationsClone.findIndex(p => p === overlapResult[0]);
        permutationsClone.splice(indexOfPermutation, 1);

        // Add the non-overlapping characters to the super permutation
        const nonOverlappingChars = overlapResult[0].substring(overlapResult[1], permutationLength);
        if (overlapResult[1] === 0) {
          this.superpermutation = this.superpermutation.concat(overlapResult[0]);
        } else {
          this.superpermutation = this.superpermutation.concat(nonOverlappingChars);
        }

        overlapResult = this.findLargestOverlap(overlapResult[0], permutationsClone);
      }
    }
  }

  // Find the largest overlap for a given string from the given permutations and return the overlapping permutation
  // And its overlap size
  findLargestOverlap(targetString: string, permutations: string[]): [string, number] {
    // Short circuit when there is only one permutation left
    if (permutations.length === 1) {
      return [permutations[0], permutations[0].length];
    }

    // Create a map with an entry for each length of the chopped permutations
    const map = {};
    const lengthOfString = permutations[0].length;
    // Iterate through the permutation list X - 1 times to fill the map for the chopped lengths
    for (let x = 1; x < lengthOfString; x++) {
      map[lengthOfString - x] = permutations
        .map(p => {
          return {
            perm: p,
            substring: p.substring(0, lengthOfString - x),
          };
        });
    }

    for (const lengthOfSubstring of Object.keys(map).reverse()) {
      const substrings = map[lengthOfSubstring];
      for (const ss of substrings) {
        if (targetString.endsWith(ss.substring)) {
          return [ss.perm, +lengthOfSubstring];
        }
      }
    }
  }
}
